# timeattack0603
timeattack0603


import pandas as pd
import numpy as np

category = pd.read_csv('drinks_category.csv',encoding='euc-kr')
ratings = pd.read_csv('new_drink_ratings.csv',encoding='euc-kr')

# 데이터프레임을 출력했을때 더 많은 열이 보이도록 함
pd.set_option('display.max_columns', 10)
pd.set_option('display.width', 300)
# movieId를 기준으로 ratings 와 category 를 결합함
drink_ratings = pd.merge(ratings, category, on='drinkId')
print(drink_ratings)


        userId  drinkId  rating   timestamp           title category                                          image_url
0            1       47     4.0   964982703  헤이즐넛 스타벅스 더블 샷    에스프레소  https://image.istarbucks.co.kr/upload/store/sk...
1            1       47     5.0   964982588  헤이즐넛 스타벅스 더블 샷    에스프레소  https://image.istarbucks.co.kr/upload/store/sk...
2            1       47     4.0   964983056  헤이즐넛 스타벅스 더블 샷    에스프레소  https://image.istarbucks.co.kr/upload/store/sk...
3            1       47     4.0   964981710  헤이즐넛 스타벅스 더블 샷    에스프레소  https://image.istarbucks.co.kr/upload/store/sk...
4            1       47     5.0   964982703  헤이즐넛 스타벅스 더블 샷    에스프레소  https://image.istarbucks.co.kr/upload/store/sk...
...        ...      ...     ...         ...             ...      ...                                                ...
100831     610       35     3.5  1493846199  아이스 화이트 초콜릿 모카    에스프레소  https://image.istarbucks.co.kr/upload/store/sk...
100832     610       35     4.5  1479542155  아이스 화이트 초콜릿 모카    에스프레소  https://image.istarbucks.co.kr/upload/store/sk...
100833     610       35     4.5  1493848331  아이스 화이트 초콜릿 모카    에스프레소  https://image.istarbucks.co.kr/upload/store/sk...
100834     610       35     4.5  1479544589  아이스 화이트 초콜릿 모카    에스프레소  https://image.istarbucks.co.kr/upload/store/sk...
100835     610       35     4.5  1493848418  아이스 화이트 초콜릿 모카    에스프레소  https://image.istarbucks.co.kr/upload/store/sk...

[100836 rows x 7 columns]

# user별로 음료에 부여한 rating 값을 볼 수 있도록 pivot table 사용
title_user = drink_ratings.pivot_table('rating', index='userId', columns='title')

# 평점을 부여안한 음료는 그냥 0이라고 부여
title_user = title_user.fillna(0)
print(title_user)

title   나이트로 바닐라 크림  나이트로 콜드 브루  더블 에스프레소 칩 프라푸치노  돌체 콜드 브루  딸기 딜라이트 요거트 블렌디드  ...  피치 & 레몬 블렌디드  헤이즐넛 스타벅스 더블 샷  화이트 초콜릿 모카  화이트 초콜릿 모카 프라푸치노  화이트 타이거 프라푸치노
userId                                                                         ...                                                                           
1          4.250000    4.250000          5.000000  4.500000          4.285714  ...      2.666667        4.400000    4.500000          4.000000       4.500000
2          4.000000    0.000000          0.000000  0.000000          0.000000  ...      0.000000        0.000000    0.000000          0.000000       3.500000
3          0.000000    2.000000          0.000000  0.000000          0.500000  ...      0.000000        0.000000    0.000000          0.000000       0.000000
4          2.750000    3.000000          3.000000  0.000000          3.333333  ...      0.000000        3.750000    3.750000          2.500000       3.500000
5          0.000000    3.000000          0.000000  4.000000          0.000000  ...      0.000000        5.000000    3.333333          0.000000       5.000000
...             ...         ...               ...       ...               ...  ...           ...             ...         ...               ...            ...
606        3.500000    3.727273          3.566667  3.700000          3.657895  ...      3.318182        3.538462    3.695652          3.638889       3.818182
607        4.333333    3.000000          4.400000  3.750000          5.000000  ...      0.000000        4.500000    4.333333          3.666667       3.500000
608        2.650000    3.033333          3.555556  3.227273          3.187500  ...      2.636364        3.307692    3.000000          3.153846       4.071429
609        3.333333    0.000000          3.000000  3.500000          0.000000  ...      0.000000        0.000000    4.000000          0.000000       3.000000
610        3.900000    3.500000          3.916667  3.950000          3.736842  ...      3.854167        3.850000    3.884615          3.911765       3.500000

[610 rows x 68 columns]

from sklearn.metrics.pairwise import cosine_similarity

# 유저 1~610 번과 유저 1~610 번 간의 코사인 유사도를 구함
user_based_collab = cosine_similarity(title_user, title_user)
print(user_based_collab)

[[1.         0.55781352 0.52013115 ... 0.97026139 0.60719663 0.9694702 ]
 [0.55781352 1.         0.42865956 ... 0.54598261 0.45443659 0.55732635]
 [0.52013115 0.42865956 1.         ... 0.52102856 0.25920691 0.51468792]
 ...
 [0.97026139 0.54598261 0.52102856 ... 1.         0.60657497 0.99312733]
 [0.60719663 0.45443659 0.25920691 ... 0.60657497 1.         0.61417118]
 [0.9694702  0.55732635 0.51468792 ... 0.99312733 0.61417118 1.        ]]
 
 # 위는 그냥 numpy 행렬이니까, 이를 데이터프레임으로 변환
user_based_collab = pd.DataFrame(user_based_collab, index=title_user.index, columns=title_user.index)
print(user_based_collab)

userId       1         2         3         4         5    ...       606       607       608       609       610
userId                                                    ...                                                  
1       1.000000  0.557814  0.520131  0.909431  0.659164  ...  0.970348  0.940537  0.970261  0.607197  0.969470
2       0.557814  1.000000  0.428660  0.562590  0.417599  ...  0.559501  0.538891  0.545983  0.454437  0.557326
3       0.520131  0.428660  1.000000  0.505189  0.367047  ...  0.522956  0.496122  0.521029  0.259207  0.514688
4       0.909431  0.562590  0.505189  1.000000  0.656898  ...  0.935367  0.900462  0.931903  0.521320  0.932117
5       0.659164  0.417599  0.367047  0.656898  1.000000  ...  0.663394  0.602175  0.667187  0.454293  0.660933
...          ...       ...       ...       ...       ...  ...       ...       ...       ...       ...       ...
606     0.970348  0.559501  0.522956  0.935367  0.663394  ...  1.000000  0.957386  0.994263  0.604784  0.997420
607     0.940537  0.538891  0.496122  0.900462  0.602175  ...  0.957386  1.000000  0.950480  0.628988  0.958102
608     0.970261  0.545983  0.521029  0.931903  0.667187  ...  0.994263  0.950480  1.000000  0.606575  0.993127
609     0.607197  0.454437  0.259207  0.521320  0.454293  ...  0.604784  0.628988  0.606575  1.000000  0.614171
610     0.969470  0.557326  0.514688  0.932117  0.660933  ...  0.997420  0.958102  0.993127  0.614171  1.000000

[610 rows x 610 columns]

# 1번 유저와 비슷한 유저를 내림차순으로 정렬한 후에, 상위 10개만 뽑음
print(user_based_collab[1].sort_values(ascending=False)[:10])

userId
1      1.000000
105    0.973208
525    0.973099
474    0.972854
480    0.972689
318    0.972193
249    0.971707
45     0.971616
599    0.971600
477    0.971553
Name: 1, dtype: float64

# 1번 유저와 가장 비슷한 266번 유저를 뽑고,
user = user_based_collab[1].sort_values(ascending=False)[:10].index[1]
# 266번 유저가 좋아했던 영화를 평점 내림차순으로 출력
result = title_user.query(f"userId == {user}").sort_values(ascending=False, by=user, axis=1)
print(result)

title   카페 모카  클래식 아포가토  아이스 카푸치노     에스프레소  에스프레소 프라푸치노  ...  나이트로 콜드 브루  블론드 바닐라 더블 샷 마키아또  화이트 초콜릿 모카 프라푸치노  모카 프라푸치노  아이스 카페 아메리카노
userId                                                    ...                                                                         
105      4.75    4.4375  4.416667  4.409091        4.375  ...    3.857143               3.85            3.8125  3.766667      3.722222

[1 rows x 68 columns]

# 만약 해당 유저가 아직 마시지 않은 음료에 대해서, 평점을 예측하고자 한다면?
# (어떤 유저와 비슷한 정도 * 그 유저가 음료에 대해 부여한 평점) 을 더해서 (유저와 비슷한 정도의 합)으로 나눠보면 됨!
# index_list 는 비슷한 유저의 id 값 리스트 / weight_list 는 비슷한 유저와의 유사도 리스트
user_index_list = user_based_collab[1].sort_values(ascending=False)[:10].index.tolist()
user_weight_list = user_based_collab[1].sort_values(ascending=False)[:10].tolist()
print(user_index_list)
print(user_weight_list)

[1, 105, 525, 474, 480, 318, 249, 45, 599, 477]
[0.9999999999999997, 0.9732081092557315, 0.9730994460793512, 0.9728537299333857, 0.9726893766969738, 0.972192860220462, 0.9717069114178052, 0.9716157405387147, 0.9715995614391639, 0.971553257165392]
[45]
0초
        weighted_user.append(user_weight_list[i])

print(weighted_sum)
print(weighted_user)
# 총 평점*유사도 / 총 유사도를 토대로 평점 예측
print(sum(weighted_sum)/sum(weighted_user))
[3.892832437022926, 3.2668338546949647, 3.40498805476685, 2.6586842963050614, 3.5352467644380434, 3.7788602110692424, 4.129366897289538, 2.720478772029659, 3.303281074362333]
[0.9732081092557315, 0.9730994460793512, 0.9728537299333857, 0.9726893766969738, 0.972192860220462, 0.9717069114178052, 0.9716157405387147, 0.9715995614391639, 0.971553257165392]
3.5072859549721604
[ ]

# 1번 유저가 모카 롤린 민트 초코 콜드 브루먹고 어떤 평점을 부여할지 예측
drink_title = '롤린 민트 초코 콜드 브루'
weighted_sum = []
weighted_user = []
for i in range(1, 10):
    # 해당 영화를 보고 평점을 부여한 사람들의 유사도와 평점만 추가 (즉, 0이 아닌 경우에만 계산에 활용)
    if int(title_user[drink_title][user_index_list[i]]) is not 0:
        # 평점 * 유사도 추가
        weighted_sum.append(title_user[drink_title][user_index_list[i]] * user_weight_list[i])
        # 유사도 추가
        weighted_user.append(user_weight_list[i])

print(weighted_sum)
print(weighted_user)
# 총 평점*유사도 / 총 유사도를 토대로 평점 예측
print(sum(weighted_sum)/sum(weighted_user))

[3.892832437022926, 3.2668338546949647, 3.40498805476685, 2.6586842963050614, 3.5352467644380434, 3.7788602110692424, 4.129366897289538, 2.720478772029659, 3.303281074362333]
[0.9732081092557315, 0.9730994460793512, 0.9728537299333857, 0.9726893766969738, 0.972192860220462, 0.9717069114178052, 0.9716157405387147, 0.9715995614391639, 0.971553257165392]
3.5072859549721604
